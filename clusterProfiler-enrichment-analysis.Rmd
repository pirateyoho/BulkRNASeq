---
title: "clusterProfiler-enrichment-analysis"
author: "Eileen Owens"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r installation, include=FALSE}
# Load necessary packages
library(clusterProfiler)
library(pathview)
library(enrichplot)
library(ggplot2)
library(ggnewscale)
library(msigdbr)
library(DOSE)
library(ReactomePA)
library(tidyverse)
```


```{r data-input, echo=FALSE}
# Set working directory:
setwd("~/PTCL/PROJ01_26PTCLs/02_scripts")
# Read in data from deseq2
df = read.csv("../01_input/CD4PTCLvsCD4CTRL_DESeq2res_BlankIDsRemoved.csv", header=TRUE)
# take the stat column from DESeq2 results for ranking
original_gene_list <- df$stat
# name the vector of probe IDs (ENSEMBL gene IDs)
names(original_gene_list) <- df$X
# omit any NA values
gene_list <- na.omit(original_gene_list)
# sort the list in decreasing order (required for clusterProfiler)
gene_list = sort(gene_list, decreasing = TRUE)
```

```{r annotations, echo=FALSE}
# Install annotations
## Install and load the canine genome annotations. All available annotations can be found here: http://bioconductor.org/packages/release/BiocViews.html#___OrgDb.
organism = "org.Cf.eg.db" # Set the desired organism.
# BiocManager::install(organism, character.only=TRUE) # First time only, then comment out this line.
library(organism, character.only=TRUE)
```

# Gene Set Enrichment Analysis Using Gene Ontology
```{r gseGO, echo=FALSE, message=FALSE}
gse <- gseGO(geneList=gene_list,
             ont = "ALL",
             keyType = "ENSEMBL", # to see options for the keyType command, run keytypes(org.Hs.eg.db)
             nPerm = 10000,
             minGSSize = 3,
             maxGSSize = 800,
             pvalueCutoff = 1.0,
             verbose = TRUE,
             OrgDb = organism,
             pAdjustMethod = "BH")

## Export results
gse_df <- as.data.frame(gse)
write.csv(gse_df, file="../03_output/230124_all_gseGO_results.csv")
```

## Dotplot
```{r gseGO-dotplot, echo=FALSE}
dotplot(gse, showCategory=10, split=".sign") + facet_grid(.~.sign)
```

## Enrichment map
Organizes enriched terms into a network with edges connecting overlapping gene sets. In this way, mutually overlapping gene sets tend to cluster together, making it easy to identify functional modules.
```{r gseGO-enrichmentmap, echo=FALSE}
gse2 <- pairwise_termsim(gse)
emapplot(gse2, showCategory=10)
```

## Category netplot
Displays the linkages of genes and biological concepts (e.g., CO terms or KEGG pathways) as a network. Helpful to see which genes are involved in enriched pathways and genes that may belong to multiple annotation categories.
```{r gse-cnetplot, echo=FALSE}
cnetplot(gse, categorySize="pvalue", foldChange=gene_list, showCategory=4) # Category size can be either ' pvalue' or 'geneNum'
```

## Ridgeplot
Grouped by gene set, density plots are generated by using the frequency of fold change values per gene within each set. Helpful to interpret up/down-regulated pathways.
```{r gseGO-ridgeplot, echo=FALSE}
ridgeplot(gse, showCategory=15) + labs(x = "enrichment distribution")
```


# GO over-representation analysis
```{r enrichGO, echo=FALSE}
# Subset the top 250 upregulated genes for GO over-representation analysis.
df_top250 = read.csv("../01_input/CD4PTCLvsCD4CTRL_Top250_BlanksRemoved.csv", header=TRUE)
head(df_top250)
top250 <- df_top250$gene_name

# Perform GO over-representation analysis.
ego <- enrichGO(gene=top250,
                ont = "ALL",
                universe = names(original_gene_list),
                keyType = "SYMBOL",
                OrgDb = org.Hs.eg.db,
                pAdjustMethod = "BH",
                pvalueCutoff = 1.0,
                qvalueCutoff = 1.0,
                readable = FALSE) # Set readable to FALSE since we are already using "Symbol" as the keytype.

# Export results
ego_df <- as.data.frame(ego)
write.csv(ego_df, file="../03_output/230124_all_enrichGO_results.csv")
```

## Dotplot
```{r enrichGO-dotplot, echo=FALSE}
dotplot(ego, x="count", showCategory=20, color="qvalue")

# To make a dotplot of select user-supplied pathways, with enrichment data imported from a CSV (e.g., comparing your dataset to pathways enriched in a publication), run the code below. Otherwise, comment this section out prior to knitting.
#gengcsv <- read.csv("../01_input/enrichGO_GengPathwaysOnly.csv")
#gengcsv <- as.data.frame(gengcsv)
#head(gengcsv)

#ggplot(data=gengcsv, aes(x = Condition, y = Description, size = Count, color = qvalue)) + geom_point() + scale_color_gradient(low = "red", high = "blue") + theme_bw() + ylab("") + xlab("") + ggtitle("GO Enrichment Analysis")
```

# KEGG Gene Set Enrichment Analysis

```{r kegg-input, echo=FALSE}
# Requires converting id types to Entrez gene IDs. We can use the bitr function for this (included in clusterProfiler). It is normal for this call to produce some messages/warnings. 
#In the bitr function, the param fromType should be the same as keyType from the gseGO function above (the annotation source). This param is used again in the next 2 steps: creating dedup_ids and df2.
#toType in the bitr function has to be one of the available options from keyTypes(org.Cf.eg.db) and must map to one of "kegg", "ncbi-geneid", "ncbi-proteinid" or "uniprot" because gseKEGG() only accpets one of these 4 options as its keytype parameter.

#As the initial input, use original_gene_list created above.

## Prepare input
keytypes(org.Cf.eg.db)
# Convert gene IDs for gseKEGG function
# We will lose some genes here because not all IDs will be converted
ids <- bitr(names(original_gene_list), fromType = "ENSEMBL", toType ="ENTREZID", OrgDb=organism)
dedup_ids <- ids[!duplicated(ids[c("ENSEMBL")]),] # Remove duplicate IDS (should be whatever was selected as keyType)

# Create a new dataframe which has only the genes which were successfully mapped using the bitr function.
df2 <- df[df$X %in% dedup_ids$ENSEMBL,]
df2$Y <- dedup_ids$ENTREZID # Create a new column in df2 with the corresponding ENTREZ IDs
entrez_gene_list <- df2$log2FoldChange # Create a vector of log2fc
names(entrez_gene_list) <- df2$Y # Name vector with ENTREZ ids
entrez_gene_list <- na.omit(entrez_gene_list) # Omit any NA values
entrez_gene_list = sort(entrez_gene_list, decreasing = TRUE) # Sort in decreasing order

# To filter for only genes with log2fc >1.5:
entrez_mostup <- names(entrez_gene_list)[abs(entrez_gene_list) >1.5]

# To filter for only the top 250 upregulated genes:
top250_probeID_list <- df_top250$stat # Extract the stat column from the previously sorted data frame.
names(top250_probeID_list) <- df_top250$X # Extract the ENSEMBL probe IDs
top250_ids <- bitr(names(top250_probeID_list), fromType = "ENSEMBL", toType ="ENTREZID", OrgDb=organism) # Convert to ENTREZID
top250_dedup_ids <- top250_ids[!duplicated(top250_ids[c("ENSEMBL")]),] # Remove duplicates
top250_df2 <- df_top250[df_top250$X %in% top250_dedup_ids$ENSEMBL,] # Create a new dataframe which has only the genes which were successfully mapped using the bitr function.
top250_df2$Y <- top250_dedup_ids$ENTREZID # Create a new column in df2 with the corresponding ENTREZ IDs
top250_entrez_gene_list <- top250_df2$stat # Create a vector of stat
names(top250_entrez_gene_list) <- top250_df2$Y # Name vector with ENTREZ ids
top250_entrez_gene_list <- na.omit(top250_entrez_gene_list) # Omit any NA values
top250_entrez_gene_list = sort(top250_entrez_gene_list, decreasing = TRUE) # Sort in decreasing order

```

```{r gseKEGG, echo=FALSE}
## Create gseKEGG object
# KEGG organism codes can be found here: https://www.genome.jp/kegg/catalog/org_list.html
kegg_organism = "cfa" # KEGG organism code for Canis lupus familiaris
kk2 <- gseKEGG(geneList = entrez_gene_list, # Use the sorted gene list with Entrez IDs
               organism = kegg_organism,
               nPerm = 10000, # the higher the number of permutations, the more accurate your result
               minGSSize = 3,
               maxGSSize = 800,
               pvalueCutoff = 1.0,
               pAdjustMethod = "BH",
               keyType = "ncbi-geneid")

kk3 <- enrichKEGG(gene = entrez_mostup, # Use the list of entrez IDs with log2fc > 1.5
                  organism = kegg_organism,
                  pvalueCutoff = 1.0
                  )
```

## Dotplot
```{r kegg-dotplot, echo=FALSE}
dotplot(kk2, showCategory=10, title = "Enriched Pathways", split=".sign") + facet_grid(.~.sign)
```

## Enrichment map
```{r kegg-enrichmentmap, echo=FALSE}
kk2_2 <- pairwise_termsim(kk2)
emapplot(kk2_2, showCategory = 10)
```

## Category Netplot
```{r kegg-cnetplot, echo=FALSE}
cnetplot(kk2, categorySize="pvalue", foldChange=gene_list, showCategory=5, node_label='category') # categorySize can be either 'pvalue' or 'geneNum'
```


## Ridgeplot
```{r kegg-ridgeplot, echo=FALSE}
ridgeplot(kk2) + labs(x = "enrichment distribution")
```

## GSEA Plot
```{r}
# Gene set integer corresponds to gene set in the gse object. The first gene set is 1, second gene set is 2, etc.
gseaplot(kk2, by = "all", title = kk2$Description[1], geneSetID = 1) # Use the "Gene Set" param for the index in the title, and as the value for geneSetId
```

```{r kegg-export, echo=FALSE}
## Export KEGG enrichment data.
kegg_df <- as.data.frame(kk2)
write.csv(kegg_df, file="../03_output/allgseKEGG.csv")
kegg_df2 <- as.data.frame(kk3)
write.csv(kegg_df2, file=file="../03_output/allenrichKEGG.csv")
```


# Citations
```{r}
sessionInfo()
citation()
```
